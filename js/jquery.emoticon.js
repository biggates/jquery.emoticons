/**
 * jQuery.emoticon
 * @author biggates 
 */
;(function($){
    var emoticons = {
        qq: {
            prefix: 'QQ',
            names: '微笑,撇嘴,色,发呆,得意,流泪,害羞,闭嘴,睡,大哭,尴尬,发怒,调皮,呲牙,惊讶,难过,酷,冷汗,抓狂,吐,偷笑,愉快,白眼,傲慢,饥饿,困,惊恐,流汗,憨笑,悠闲,奋斗,咒骂,疑问,嘘,晕,疯了,衰,骷髅,敲打,再见,擦汗,抠鼻,鼓掌,糗大了,坏笑,左哼哼,右哼哼,哈欠,鄙视,委屈,快哭了,阴险,亲亲,吓,可怜,菜刀,西瓜,啤酒,篮球,乒乓,咖啡,饭,猪头,玫瑰,凋谢,嘴唇,爱心,心碎,蛋糕,闪电,炸弹,刀,足球,瓢虫,便便,月亮,太阳,礼物,拥抱,强,弱,握手,胜利,抱拳,勾引,拳头,差劲,爱你,NO,OK,爱情,飞吻,跳跳,发抖,怄火,转圈,磕头,回头,跳绳,挥手,激动,街舞,献吻,左太极,右太极'.split(),
            image: 'qq.png',
            total: 105,
            width: 29,
            height: 29,
            rows: 5,
            columns: 15
        },
        emoji: {
            prefix: 'emoji',
            names: '笑脸,开心,大笑,热情,眨眼,色,接吻,亲吻,脸红,露齿笑,满意,戏弄,吐舌,无语,得意,汗,失望,低落,呸,焦虑,担心,震惊,悔恨,眼泪,哭,破涕为笑,晕,恐惧,心烦,生气,睡觉,生病,恶魔,外星人,心,心碎,丘比特,闪烁,星星,叹号,问号,睡着,水滴,音乐,火,便便,强,弱,拳头,胜利,上,下,右,左,第一,强壮,吻,热恋,男孩,女孩,女士,男士,天使,骷髅,红唇,太阳,下雨,多云,雪人,月亮,闪电,海浪,猫,小狗,老鼠,仓鼠,兔子,狗,青蛙,老虎,考拉,熊,猪,牛,野猪,猴子,马,蛇,鸽子,鸡,企鹅,毛虫,章鱼,鱼,鲸鱼,海豚,玫瑰,花,棕榈树,仙人掌,礼盒,南瓜灯,鬼魂,圣诞老人,圣诞树,礼物,铃,庆祝,气球,CD,相机,录像机,电脑,电视,电话,解锁,锁,钥匙,成交,灯泡,邮箱,浴缸,钱,炸弹,手枪,药丸,橄榄球,篮球,足球,棒球,高尔夫,奖杯,入侵者,唱歌,吉他,比基尼,皇冠,雨伞,手提包,口红,戒指,钻石,咖啡,啤酒,干杯,鸡尾酒,汉堡,薯条,意面,寿司,面条,煎蛋,冰激凌,蛋糕,苹果,飞机,火箭,自行车,高铁,警告,旗,男人,女人,O,X,版权,注册商标,商标'.split(),
            image: 'emoji.png',
            total: 168,
            width: 29,
            height: 29,
            rows: 12,
            columns: 15
        }
    };

    var defaultOptions = {
        watch: null,
        input: null,
        emoticons: emoticons
    };
    
    /**
     * Handles browser differences
     * @param $toWatch $() elements to watch
     */
    var createWatchFunction = function($toWatch, replacementArray){
        // Firefox & Chrome
        var MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver
        if(MutationObserver){
            var observer = new MutationObserver(function(mutations){
                mutations.forEach(function(mutation){
                    callFunction(mutation, replacementArray);
                });
            });
            
            $toWatch.each(function(idx, elem){
                observer.observe(elem, {childList: true});
            });
            
        } else {
            // fallback to setTimeout()
            
        }
        
    };
    
    /**
     * This is the actual 'replace' function
     * @param newElement the observed new inserted dom element
     * @param replacementArray [emoticonNames] the applied array
     */
    var callFunction = function(newElement, replacementArray){
        var $elem = $(newElement);
        if($elem.data('emoticonized')) {
            return;
        } else {
        
            var text = $elem.text();
            // replacement happens here
            for(idx : replacementArray){
                name = replacementArray[idx];
                text = text.replace('[' + name + ']', '<span class="emoticon em_' + name + '"></span>');
                text = text.replace(/\[.+\]/g, function(content){
                    // TODO check whether content is in replacementArray
                    if(content){
                        return '<span class="emoticon em_' + content + '" title="' + content + '"></span>';
                    } else {
                        return content;
                    }
                });
            }
            $elem.text(text).data('emoticonized', true);
        }
    };
    
    /*
    *  createCSSClass()
    *  http://www.happycode.info
    */
    function createCSSClass(selector, style) {
        if(typeof(style) !== 'string') {
            style = JSON.stringify(style);
        }
        console.log('createCssClass()', selector, style);
        if (!document.styleSheets) {
            return;
        }
     
        if (document.getElementsByTagName("head").length == 0) {
            return;
        }
     
        var stylesheet;
        var mediaType;
        if (document.styleSheets.length > 0) {
            for (i = 0; i < document.styleSheets.length; i++) {
                if (document.styleSheets[i].disabled) {
                    continue;
                }
                var media = document.styleSheets[i].media;
                mediaType = typeof media;
     
                if (mediaType == "string") {
                    if (media == "" || (media.indexOf("screen") != -1)) {
                        styleSheet = document.styleSheets[i];
                    }
                } else if (mediaType == "object") {
                    if (media.mediaText == "" || (media.mediaText.indexOf("screen") != -1)) {
                        styleSheet = document.styleSheets[i];
                    }
                }
     
                if (typeof styleSheet != "undefined") {
                    break;
                }
            }
        }
     
        if (typeof styleSheet == "undefined") {
            var styleSheetElement = document.createElement("style");
            styleSheetElement.type = "text/css";
     
            document.getElementsByTagName("head")[0].appendChild(styleSheetElement);
     
            for (i = 0; i < document.styleSheets.length; i++) {
                if (document.styleSheets[i].disabled) {
                    continue;
                }
                styleSheet = document.styleSheets[i];
            }
     
            var media = styleSheet.media;
            mediaType = typeof media;
        }
     
        if (mediaType == "string") {
            for (i = 0; i < styleSheet.rules.length; i++) {
                if (styleSheet.rules[i].selectorText.toLowerCase() == selector.toLowerCase()) {
                    styleSheet.rules[i].style.cssText = style;
                    return;
                }
            }
     
            styleSheet.addRule(selector, style);
        } else if (mediaType == "object") {
            for (i = 0; i < styleSheet.cssRules.length; i++) {
                if (styleSheet.cssRules[i].selectorText.toLowerCase() == selector.toLowerCase()) {
                    styleSheet.cssRules[i].style.cssText = style;
                    return;
                }
            }
     
            styleSheet.insertRule(selector + "{" + style + "}", 0);
        }
    }
    
    $.fn.emoticonize = function(options){
        var opts = $.extend(true, {}, emoticons, options);
    
        // TOOD create a table of valid emoticons
        var replacementArray = [];
        
        // create style classes
        for(i : options.emoticons) {
            var eset = options.emoticons[i];
            var currentRow = 0;
            var currentColumn = 0;
            for(int j = 0; j < eset.total; j++){
                var name = eset.names[j];
                var className = eset.prefix + '表情' + name;
                replacementArray.push(className);
                if(currentColumn >= eset.columns){
                    currentColumn = 0;
                    currentRow ++;
                }
                createCSSClass('.emoticon.em_' + className, {
                    width: eset.width + 'px',
                    height: eset.height + 'px',
                    background-image: 'url("' + eset.image + '")',
                    background-position: '' + currentColumn * eset.width + 'px ' + currentRow * eset.height + 'px'
                });
            }
        }
    
        return $.each(function(){
            var $container = options.watch || $(this);
            createWatchFunction($container, replacementArray);
        });
    };
})(jQuery); 